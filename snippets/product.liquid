<!-- /snippets/product.liquid -->

{%- comment -%}
  Renders product content

  Accepts:
  - product: {Object} Current product (required)
  - section: {Object} Image to render (required)
  - unique: {Object} Section id (required)
  - animation_anchor: {String} Hook for the AOS animation

  Usage:
  {%- render 'product' product: product, section: section, unique: unique -%}
{%- endcomment -%}
{%- liquid
  assign section_id = section_id | default: section.id
  assign unique = section_id | append: '-' | append: product.id
  assign product_sticky_enable = section.settings.product_sticky_enable | default: false
  assign section_width = section.settings.width
  assign image_layout = section.settings.image_layout
  assign image_width = section.settings.image_width
  assign hide_product_thumbnails = section.settings.hide_product_thumbnails | default: false
  assign color_swatches_type = settings.color_swatches_type
  assign enable_zoom = section.settings.enable_zoom
  assign enable_video_looping = section.settings.enable_video_looping
  assign product_image_aspect_ratio = section.settings.product_image_aspect_ratio
  assign current_variant = product.selected_or_first_available_variant
  assign featured_media = current_variant.featured_media | default: product.featured_media
  assign featured_media_id = featured_media.id
  assign first_3d_model = product.media | where: 'media_type', 'model' | first
  assign full_width_blocks = section.blocks | map: 'settings' | where: 'enable_full_width'
  assign product_wrapper_class = 'product-single__wrapper'
  assign product_wrapper_modifiers = ' ' | append: 'product-single__wrapper--carousel'
  assign product_form_id = 'AddToCartForm--' | append: unique
  assign is_quick_view = false
  if section_type == 'quickview'
    assign is_quick_view = true
  endif

  case image_layout
    when 'grid'
      assign product_wrapper_modifiers = ' ' | append: 'product-single__wrapper--grid'
    when 'stacked'
      assign product_wrapper_modifiers = ' ' | append: 'product-single__wrapper--stacked'
  endcase

  case image_width
    when 'standard'
      assign product_wrapper_modifiers = product_wrapper_modifiers | append: ' ' | append: 'product-single__wrapper--standard'
    when 'large'
      assign product_wrapper_modifiers = product_wrapper_modifiers | append: ' ' | append: 'product-single__wrapper--large'
  endcase

  capture image_size_desktop
    case image_layout
      when 'grid'
        if section_width == 'wrapper--full-padded'
          case image_width
            when 'standard'
              echo 'calc(((100vw - 120px) / 2 - 30px) / 2 - 12px)'
            when 'large'
              echo 'calc(((100vw - 120px) * 0.6 - 30px) / 2 - 12px)'
          endcase
        else
          case image_width
            when 'standard'
              echo '303px'
            when 'large'
              echo '369px'
          endcase
        endif

      when 'stacked', 'carousel'
        if section_width == 'wrapper--full-padded'
          case image_width
            when 'standard'
              echo 'calc((100vw - 120px) / 2 - 30px)'
            when 'large'
              echo 'calc((100vw - 120px) * 0.6 - 30px)'
          endcase
        else
          case image_width
            when 'standard'
              echo '630px'
            when 'large'
              echo '762px'
          endcase
        endif
    endcase
  endcapture

  comment
    Upsells and Complementary products image sizes
  endcomment
  assign upsells_image_width = settings.upsells_image_width | divided_by: 100.0
  assign full_width = '100vw'
  assign wrapper_width = '1440px'
  if section_width == 'wrapper--full-padded'
    assign wrapper_width = full_width
  endif
  assign wrapper_width_lg = '(' | append: wrapper_width | append: ' - 120px)'
  assign wrapper_width_md = '(' | append: full_width | append: ' - 40px)'

  assign content_basis = 0.5
  if image_width == 'large'
    assign content_basis = 0.4
  endif

  assign content_width_lg = wrapper_width_lg | append: ' * ' | append: content_basis | append: ' - 30px'
  assign content_width_md = wrapper_width_md | append: ' * ' | append: content_basis | append: ' - 30px'
  assign content_width_sm = wrapper_width_md
  assign upsells_inner_padding = '2 * 12px'

  assign img_width_lg = 'calc((' | append: content_width_lg | append: ' - ' | append: upsells_inner_padding | append: ') * ' | append: upsells_image_width | append: ')'
  assign img_width_md = 'calc((' | append: content_width_md | append: ' - ' | append: upsells_inner_padding | append: ') * ' | append: upsells_image_width | append: ')'
  assign img_width_sm = 'calc((' | append: content_width_sm | append: ' - ' | append: upsells_inner_padding | append: ') * ' | append: upsells_image_width | append: ')'

  assign upsells_sizes = '(min-width: 1024px) ' | append: img_width_lg | append: ', (min-width: 768px) ' | append: img_width_md | append: ', ' | append: img_width_sm

  assign product_gallery_class = 'product-gallery'
  assign product_gallery_modifiers = ''
  if image_layout == 'grid' and product_image_aspect_ratio
    assign product_gallery_modifiers = product_gallery_modifiers | append: ' ' | append: 'product-gallery--equal'
  endif

  assign sold_out = true
  if current_variant.available
    assign sold_out = false
  endif

  if product != blank
    assign product_title = product.title | strip_html | escape
    assign product_url = product.url
  else
    assign product_title = 'homepage.onboarding.product_title' | t
    assign product_url = '#!'
  endif

  if product.media.size < 2 and section_type == 'featured'
    assign hide_product_thumbnails = true
  endif

  assign animations_enabled = settings.animations_enabled
  assign aos_anchor_default = unique | prepend: '#'
  assign animation_anchor = animation_anchor | default: aos_anchor_default
  assign animation_order = 1
  assign show_sale_badge_on_quick_view = false
  assign show_custom_badge_on_quick_view = false

  comment
    Quick View related settings
  endcomment
  if is_quick_view
    assign animations_enabled = false
    assign hide_product_thumbnails = true
    assign show_labels = settings.show_labels
    assign show_quantity = settings.show_quantity
    assign show_payment_button = settings.show_payment_button
    assign show_remaining = settings.show_remaining
    assign enable_video_looping = settings.enable_video_looping
    assign show_sale_badge_on_quick_view = settings.show_sale_badge
    assign show_custom_badge_on_quick_view = settings.show_custom_badge
  endif

  assign hide_labels_class = ''
  unless show_labels
    assign hide_labels_class = ' variant__labels--hide'
  endunless

  comment
    PDP form buttons
  endcomment
  assign enable_half_width_btn = settings.enable_half_width_btn
  assign atc_show_product_price = settings.atc_show_product_price

  assign max_inventory = ''
  assign max_inventory_reached = false
  assign form_qty = current_variant.quantity_rule.min
  assign cart_qty = cart | item_count_for_variant: current_variant.id
  assign qty_sum = form_qty | plus: cart_qty
  assign error_message_position = 'cart'

  if current_variant.inventory_management and current_variant.inventory_policy == 'deny'
    assign max_inventory = current_variant.inventory_quantity
  endif

  if max_inventory != ''
    if qty_sum > max_inventory
      assign max_inventory_reached = true
    endif

    if cart_qty == max_inventory
      assign error_message_position = 'form'
    endif
  endif

  assign current_variant_title = product_title | append: ' - ' | append: current_variant.title

  assign label_text_caps = false
  if settings.label_caps
    assign label_text_caps = true
  endif

  assign custom_badge_metafield_text = ''
  assign show_badges_over_gallery = false
  assign show_sale_badge = false
  assign show_custom_badge = false
  assign show_sale_badge_setting = section.blocks | map: 'settings' | where: 'show_sale_badge'
  assign show_custom_badge_setting = section.blocks | map: 'settings' | where: 'show_custom_badge'
  assign show_badges_over_gallery_setting = section.blocks | map: 'settings' | where: 'show_badges_over_gallery'

  if show_badges_over_gallery_setting.size > 0 or is_quick_view
    assign show_badges_over_gallery = true
  endif

  if show_sale_badge_setting.size > 0 or show_sale_badge_on_quick_view
    assign show_sale_badge = true
  endif

  if show_custom_badge_setting.size > 0 or show_custom_badge_on_quick_view
    assign show_custom_badge = true
  endif

  if product.metafields.theme.badge != blank and product.metafields.theme.badge.type == 'single_line_text_field'
    assign custom_badge_metafield_text = product.metafields.theme.badge.value
  else
    assign show_custom_badge = false
  endif

  unless product.compare_at_price > product.price
    assign show_sale_badge = false
  endunless

  assign show_badges = false
  if show_sale_badge or show_custom_badge
    assign show_badges = true
  endif

  assign wrapper_tag = 'div'
  if product_sticky_enable
    assign wrapper_tag = 'product-sticky'
  endif
-%}

{%- capture product_gallery -%}
  {%- unless product == blank -%}
    <div class="{{ product_gallery_class }}{{ product_gallery_modifiers }}"
      id="ProductPhoto--{{ unique }}"
      data-gallery="{{ enable_zoom }}"
      data-product-single-media-group
      {% if animations_enabled %}
        data-aos="fade"
        data-aos-anchor="{{ animation_anchor }}"
        data-aos-duration="500"
        data-aos-order="{{ animation_order }}"
        {%- assign animation_order = animation_order | plus: 1 -%}
      {% endif %}
    >
      <div class="product-gallery__media-slider{% if product.media.size == 1 %} product-gallery__media-slider--single{% endif %}" data-product-single-media-slider>
        {%- if product.media.size > 0 -%}
          {%- comment -%} Show Featured media first {%- endcomment -%}
          {%- render 'media', unique: unique, current_variant: current_variant, media: featured_media, featured_media: featured_media, image_width: image_size_desktop, enable_video_looping: enable_video_looping, enable_zoom: enable_zoom, section_type: section_type, autoplay: false -%}

          {%- comment -%} Loop product media skipping the featured {%- endcomment -%}
          {%- for media in product.media -%}
            {%- if media.id != featured_media_id -%}
              {%- render 'media', unique: unique, current_variant: current_variant, media: media, featured_media: featured_media, image_width: image_size_desktop, enable_video_looping: enable_video_looping, enable_zoom: enable_zoom, section_type: section_type, autoplay: false -%}
            {%- endif -%}
          {%- endfor -%}
        {%- else -%}
          {%- assign media_aspect_ratio = 1 -%}
          {%- assign media_padding_top = 1 | divided_by: media_aspect_ratio | times: 100 | round: 1 -%}

          <div
            id="FeaturedMedia-{{ unique }}"
            class="product-gallery__media-slide{% unless featured_media == media %} media--hidden{% endunless %}"
            data-id="{{ unique }}"
            data-media-id="{{ unique }}"
            data-aspectratio="{{ media_aspect_ratio }}"
            data-product-single-media-wrapper>
            <div class="product-gallery__media product-gallery__media--image">
              <div class="product-gallery__media-space" style="--media-padding-top: {{ media_padding_top }}%;"></div>
              {%- render 'image-fill', aspect_ratio: 1, is_background: true, img_object: '', alt: product_title, placeholder_svg: 'image' -%}
            </div>
          </div>
        {%- endif -%}
      </div>

      {%- if first_3d_model -%}
        <button
          aria-label="{{ 'products.product.view_in_space_label' | t }}"
          class="btn btn--ar product-gallery__view-in-space"
          data-shopify-xr
          data-shopify-model3d-id="{{ first_3d_model.id }}"
          data-shopify-title="{{ product.title | strip_html | escape }}"
          data-shopify-xr-hidden>

          {%- render 'icon-media-model' -%}
          <span class='product-gallery__view-in-space-text'>{{ 'products.product.view_in_space' | t }}</span>
        </button>
      {%- endif -%}

      {%- comment -%} Product Thumbnails {%- endcomment -%}
      {%- if product.media.size > 1 and hide_product_thumbnails == false -%}
        <div class="product-single__thumbnails" id="ProductThumbs" data-product-single-media-thumbs>
          {%- comment -%} Show Featured media thumbnail first {%- endcomment -%}
          {%- render 'media-thumb', media: featured_media, featured_media: featured_media, has_link: true, product_title: product.title -%}

          {%- comment -%} Loop product media skipping the featured media thumbnail {%- endcomment -%}
          {%- for media in product.media -%}
            {%- if media.id != featured_media_id -%}
              {%- render 'media-thumb', media: media, featured_media: featured_media, has_link: true, product_title: product.title -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- endif -%}

      {%- if show_badges_over_gallery and show_badges -%}
        <div class="product-badge"
          {% if animations_enabled %}
            data-aos="fade"
            data-aos-anchor="{{ animation_anchor }}"
            data-aos-order="{{ animation_order }}"
            {%- assign animation_order = animation_order | plus: 1 -%}
          {% endif %}>
          {%- if show_custom_badge -%}
            <div class="product-badge__item product-badge__item--custom">
              <span>{{ custom_badge_metafield_text }}</span>
            </div>
          {%- endif -%}
          {%- if show_sale_badge -%}
            <div class="product-badge__item product-badge__item--sale">
              <span>{{ 'products.product.sale' | t }}</span>
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if enable_zoom -%}
        <zoom-images></zoom-images>

        <script src="{{ 'zoom.js' | asset_url }}" defer="defer"></script>
      {%- endif -%}
    </div>
  {%- else -%}
    {%- comment -%} Onboarding product media {%- endcomment -%}
    <div id="ProductPhoto--{{ unique }}"
      class="featured-product__gallery"
      {% if animations_enabled %}
        data-aos="fade"
        data-aos-anchor="{{ animation_anchor }}"
        data-aos-order="{{ animation_order }}"
        {%- assign animation_order = animation_order | plus: 1 -%}
      {% endif %}>
      <div class="featured-product__gallery__slider product-gallery__media-slider" data-product-single-media-slider>
        <div class="product-gallery__media-slide">
          <div class="product-gallery__media product-gallery__media--onboarding">
            {{- 'product-5' | placeholder_svg_tag: 'placeholder-svg' -}}
          </div>
        </div>
      </div>
    </div>
  {%- endunless -%}
{%- endcapture -%}

<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>

{%- unless is_quick_view -%}
  {{ 'template-product.css' | asset_url | stylesheet_tag }}

  {%- if product_sticky_enable -%}
    <script src="{{ 'product-sticky.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}

  {% if request.design_mode %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (window.productBlockSelectHandlerAttached) return;
        window.productBlockSelectHandlerAttached = true;

        document.addEventListener('shopify:block:select', (event) => {
          const target = event.target;
          // Check if the event target is within a product-info
          const productInfo = target.closest('product-info');
          if (!productInfo) return;

          const flkty = window.theme.Flickity.data(target.closest('[data-slider]'));
          const index = parseInt([...target.parentNode.children].indexOf(target));

          if (flkty && flkty.isActive) {
            flkty.select(index);
          }
        });
      });
    </script>
  {% endif %}

  <product-info
    id="MainProduct--{{ unique }}"
    class="{{ product_wrapper_class }}{{ product_wrapper_modifiers }}"
    data-section="{{ section_id }}"
    data-section-id="{{ unique }}"
    data-tall-layout="{% if section.settings.image_layout == 'carousel' %}false{% else %}true{% endif %}"
    data-product-handle="{{ product.handle }}"
    data-product-id="{{ product.id }}"
    data-url="{{ product.url }}"
    {%- if section_type == 'featured' -%}
      data-update-url="false"
    {%- endif -%}
  >
    {%- comment -%} Product media {%- endcomment -%}
    {{ product_gallery }}

    {%- comment -%} Product details {%- endcomment -%}
    <collapsible-elements class="product-single__details" data-collapsible-single>
      <{{ wrapper_tag }} class="form__wrapper">
        {%- for block in section.blocks -%}
          {%- liquid
            assign enable_full_width = block.settings.enable_full_width
            assign padding_bottom = block.settings.padding_bottom

            if padding_bottom != blank
              capture block_style
                echo 'style="--PBB:' | append: padding_bottom | append: 'px;"'
              endcapture
            endif
          -%}

          {%- case block.type -%}
            {%- when '@app' -%}
              {%- capture app_code -%}
                {%- render block -%}
              {%- endcapture -%}

              {% capture animations_attributes %}
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
              {% endcapture %}

              <div class="product__block standard__app" {{ animations_attributes }} {{ block.shopify_attributes }}>
                {{ app_code }}
              </div>

            {%- when 'title' -%}
              {%- liquid
                assign title_size = block.settings.title_size | times: 0.01
                assign price_size = block.settings.price_size | times: 0.01
                assign bold_price = block.settings.bold_price

                if title_size != 1
                  capture title_style
                    echo ' style="--adjust-heading: calc(var(--FONT-ADJUST-HEADING) * ' | append: title_size | append: ');"'
                  endcapture
                endif
              -%}

              <div
                class="product__block product__title-and-price"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block.shopify_attributes }}
              >
                {%- case block.settings.subheading -%}
                  {%- when 'breadcrumbs' -%}
                    {%- render 'breadcrumbs' -%}

                  {%- when 'collection' -%}
                    {%- if collection or product.collections.size > 0 -%}
                      {%- assign collection = collection | default: product.collections[0] -%}

                      <nav class="breadcrumbs">
                        <a href="{{ collection.url }}" title="{{ collection.title | strip_html | escape }}">
                          {{- collection.title -}}
                        </a>
                      </nav>
                    {%- endif -%}

                  {%- when 'vendor' -%}
                    {%- unless product == blank -%}
                      {%- assign vendor = product.vendor -%}
                    {%- else -%}
                      {%- assign vendor = 'homepage.onboarding.vendor' | t -%}
                    {%- endunless -%}

                    <nav class="breadcrumbs">
                      <a href="{{ vendor | url_for_vendor }}">{{ vendor }}</a>
                    </nav>
                {%- endcase -%}

                <h1
                  class="product__title"
                  {% if title_style != blank %}
                    {{- title_style -}}
                  {% endif %}
                >
                  {%- if template.name == 'product' and section_type != 'featured' -%}
                    {{- product_title -}}
                  {%- else -%}
                    <a href="{{ product_url }}" title="{{ product_title }}">{{ product_title }}</a>
                  {%- endif -%}
                </h1>
              </div>{%- liquid
  assign currency_code_enable = settings.currency_code_enable

  if price_size != 1
    capture price_style
      echo ' style="'
      echo '--adjust-body-desktop: calc(var(--FONT-ADJUST-BODY) * ' | append: price_size | append: ');'
      if price_size_mobile != blank
        echo ' --adjust-body-mobile: calc(var(--FONT-ADJUST-BODY) * ' | append: price_size_mobile | append: ');'
      endif
      echo '"'
    endcapture
  endif

  assign show_saving_badge = settings.show_saving_badge
  assign saving_badge_type = settings.saving_badge_type
  assign global_final_sale_enabled = settings.final_sale

  # Check final sale status - global setting acts as master switch
  assign is_final_sale = false
  if global_final_sale_enabled
    # Only check metafields if global setting is enabled

    # First check variant-level metafield (highest priority)
    assign variant_sale_product = current_variant.metafields.theme.final_sale.value
    if variant_sale_product != null
      # Variant metafield exists - use its value (true or false)
      assign is_final_sale = variant_sale_product
    else
      # No variant metafield - check product-level metafield
      assign final_sale_product = product.metafields.theme.final_sale.value
      unless final_sale_product == null
        assign is_final_sale = final_sale_product
      endunless
    endif
  endif

  assign color_body_text = settings.color_body_text
  assign final_sale_color = settings.final_sale_color

  if final_sale_color.alpha == 0.0 or final_sale_color == ''
    assign final_sale_color = color_body_text
  endif

  capture sale_style
    echo '--final-sale-color: ' | append: final_sale_color | append: ';'
  endcapture
  assign discount_amount = ''
  assign compare_price = current_variant.compare_at_price | times: 1.0
  assign sale_price = current_variant.price | times: 1.0

  if compare_price and sale_price
    if compare_price > sale_price
      if saving_badge_type == 'percentage'
        assign discount_difference = compare_price | minus: sale_price
        assign discount_percentage = discount_difference | divided_by: compare_price | times: 100
        assign discount_int = discount_percentage | round
        if discount_int > 0
          assign discount_amount = discount_int | append: '%'
        endif
      else
        assign discount = compare_price | minus: sale_price
        if discount > 0
          if settings.currency_code_enable
            assign discount_amount = discount | money_with_currency
          else
            assign discount_amount = discount | money
          endif
        endif
      endif
    endif
  endif
-%}

{% capture saving_final_sale_markup %}
  {% if show_saving_badge or is_final_sale %}
    <span class="product__price--off"
      {% if is_final_sale %} data-final-sale{% endif %}
      style="{{ sale_style }}"
    >
      {% if show_saving_badge and discount_amount != '' %}
        <span class="product__price-badge">
          {{ 'products.product.save' | t }}
          <span>{{ discount_amount }}</span>
        </span>
      {% endif %}

      {%- if is_final_sale -%}
        <span class="product__final-sale-wrap">
          <span class="product__final-sale">{{ 'products.product.final_sale' | t }}</span>
          <tooltip-component class="product__final-sale-question" data-tooltip="{{ settings.final_sale_tooltip | replace: '"', "'" }}">{%- render 'icon-question' -%}</tooltip-component>
        </span>
      {%- endif -%}
    </span>
  {% endif %}
{% endcapture %}

<div
  class="product__block product__price-and-badge"
  {% if animations_enabled %}
    data-aos="hero"
    data-aos-anchor="{{ animation_anchor }}"
    data-aos-order="{{ animation_order }}"
    {%- assign animation_order = animation_order | plus: 1 -%}
  {% endif %}
  {{ block_style }}
>
  <div class="product__price-wrapper" id="Price-{{ unique }}">
    <div
      class="product__price"
      data-price-wrapper
      {% if price_style != blank %}
        {{- price_style -}}
      {% endif %}
    >
      {%- unless product == blank -%}
        <span
          data-product-price
          class="product__price--regular{% if current_variant.compare_at_price > current_variant.price %} product__price--sale{% endif %}{% if bold_price %} product__price--bold{% endif %}"
        >
          {%- liquid
            if current_variant.price == 0
              echo 'products.product.free' | t
            elsif currency_code_enable
              echo current_variant.price | money_with_currency
            else
              echo current_variant.price | money
            endif
          -%}
        </span>
      {%- else -%}
        <span id="ProductPrice" class="product__price--regular{% if bold_price %} product__price--bold{% endif %}">
          {%- liquid
            if currency_code_enable
              echo 1999 | money_with_currency
            else
              echo 1999 | money
            endif
          -%}
        </span>
      {%- endunless -%}

      {% comment %}Only show compare price if it's greater than the selling price{% endcomment %}
      {% if current_variant.compare_at_price > current_variant.price %}
        <s data-compare-price class="product__price--compare{% if bold_price %} product__price--bold{% endif %}">
          {%- liquid
            if currency_code_enable
              echo current_variant.compare_at_price | money_with_currency
            else
              echo current_variant.compare_at_price | money
            endif
          -%}
        </s>
      {% endif %}

      {%- liquid
        assign units = product.variants | map: 'unit_price' | compact
        if units[0]
          assign has_units = true
        else
          assign has_units = false
        endif
      -%}

      {%- if has_units -%}
        {%- assign current_variant_unit_price = current_variant.unit_price -%}

        {%- capture unit_price_separator -%}
          <span aria-hidden="true">/</span><span class="visually-hidden">{{ 'general.accessibility.unit_price_separator' | t }}&nbsp;</span>
        {%- endcapture -%}

        {%- capture unit_price_base_unit -%}
          <span>
            {%- if current_variant.unit_price_measurement -%}
              {% if current_variant.unit_price_measurement.reference_value != 1 %}
                {{ current_variant.unit_price_measurement.reference_value }}
              {% endif %}
              {{ current_variant.unit_price_measurement.reference_unit }}
            {%- endif -%}
          </span>
        {%- endcapture -%}

        <span class="product__unit-price">
          <span
            data-product-unit
            class="product__price--unit{% unless current_variant_unit_price %} hidden{% endunless %}"
          >
            <span class="visually-hidden">{{ 'products.product.unit_price_label' | t }}</span>
            <span data-product-unit-price id="unit-price-{{ section.id }}">
              {{- current_variant_unit_price | money -}}
            </span>
            {{ unit_price_separator }}
            <span data-product-base id="unit-price-base-{{ section.id }}">{{ unit_price_base_unit }}</span>
          </span>
        </span>
      {%- endif -%}

      {{ saving_final_sale_markup }}
    </div>
  </div>
</div>
{%- when 'form' -%}
              {%- liquid
                assign show_quantity = block.settings.show_quantity
                assign show_payment_button = block.settings.show_payment_button
                assign hide_labels_class = ''
                assign show_labels = block.settings.show_labels
                unless show_labels
                  assign hide_labels_class = ' variant__labels--hide'
                endunless
              -%}

              {%- unless product == blank -%}
                <product-form
                  class="product__block product__form__wrapper{{ hide_labels_class }}{% if sold_out %} variant--soldout{% endif %}{% if enable_half_width_btn and atc_show_product_price == false %} btn--half{% endif %}"
                  data-form-wrapper
                  {{ block_style }}
                  {{ block.shopify_attributes }}
                >
                  <div class="product__form">
                    {%- render 'product-form',
                      product: product,
                      section: section,
                      section_id: section_id,
                      block: block,
                      product_form_id: product_form_id,
                      current_variant: current_variant,
                      cart_qty: cart_qty,
                      unique: unique,
                      animations_enabled: animations_enabled,
                      animation_anchor: animation_anchor,
                      animation_order: animation_order,
                      show_quantity: show_quantity,
                      show_labels: show_labels,
                      label_text_caps: label_text_caps,
                      is_quick_view: false
                    -%}

                    {%- render 'buy-buttons',
                      product: product,
                      product_form_id: product_form_id,
                      unique: unique,
                      animations_enabled: animations_enabled,
                      animation_anchor: animation_anchor,
                      animation_order: animation_order,
                      show_quantity: show_quantity,
                      show_payment_button: show_payment_button,
                      sold_out: sold_out,
                      is_quick_view: false
                    -%}
                  </div>
                </product-form>
              {%- else -%}
                <div
                  class="product__block product__form__wrapper{{ hide_labels_class }}{% if enable_half_width_btn and atc_show_product_price == false %} btn--half{% endif %}"
                  {{ block_style }}
                  {{ block.shopify_attributes }}
                >
                  <div class="product__form">
                    {%- render 'product-form-onboarding', block: block -%}
                  </div>
                </div>
              {%- endunless -%}

            {%- when 'pickup' -%}
              {%- comment -%} Surface pickup availability {%- endcomment -%}
              <pickup-availability
                class="product__block product-single__store-availability-container"
                data-variant-id="{{ current_variant.id }}"
                data-variant-title="{{ product_title }}"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              ></pickup-availability>

              <script src="{{ 'pickup-availability.js' | asset_url }}" defer="defer"></script>

            {%- when 'description' -%}
              {%- if enable_full_width -%}
                {%- continue -%}
              {%- endif -%}

              <div
                class="product__block product__description rte"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {%- unless product == blank -%}
                  {{- product.description -}}
                {%- else -%}
                  <p>{{ 'homepage.onboarding.single_product_description' | t }}</p>
                {%- endunless -%}
              </div>

            {%- when 'cutline' -%}
              {%- assign cutline_color = block.settings.cutline_color -%}

              <div
                class="product__block product__cutline"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >{%- if product.metafields.theme.cutline != blank and product.metafields.theme.cutline.type == 'single_line_text_field' -%}

{%- liquid
  capture style
    case cutline_color
      when 'body'
        echo 'color: var(--text);'
      when 'accent'
        echo 'color: var(--accent);'
    endcase
  endcapture
-%}

  <p class="product-cutline" style="{{ style }}">{{ product.metafields.theme.cutline.value }}</p>
{%- endif -%}
</div>

            {%- when 'product_accordion' -%}
              {%- if enable_full_width -%}
                {%- continue -%}
              {%- endif -%}

              {%- comment -%} Accordions {%- endcomment -%}
              <div
                class="product__block product__accordions"
                id="Block--{{ block.id }}"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {%- render 'product-accordions',
                  product: product,
                  block_settings: block.settings,
                  block_id: block.id
                -%}
              </div>

            {%- when 'upsell' -%}
              {%- liquid
                assign upsell_unique = unique | append: block.id
                assign upsell_products = block.settings.product_list
                assign upsell_product_list_count = upsell_products.count
                assign legacy_upsell_product = product.metafields.theme.upsell.value | default: false

                capture upsell_items
                  for upsell_product in upsell_products
                    render 'upsell-product', upsell_product: upsell_product, index: forloop.index, unique: upsell_unique, img_sizes: upsells_sizes
                  endfor

                  if legacy_upsell_product
                    assign upsell_product_list_count = upsell_product_list_count | plus: 1
                    render 'upsell-product', upsell_product: legacy_upsell_product, index: upsell_product_list_count, unique: upsell_unique, img_sizes: upsells_sizes
                  endif

                  if upsell_product_list_count == 0
                    for i in (1..3)
                      render 'upsell-product', index: forloop.index
                    endfor
                  endif
                endcapture

                assign upsell_slider = false
                if upsell_product_list_count != 1
                  assign upsell_slider = true
                endif
              -%}

              <div
                class="product__block upsell__products{% if upsell_slider and upsell_items != '' %} upsell__products--slider{% endif %}"
                id="Block--{{ block.id }}"
                {% if animations_enabled and upsell_items != blank %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {%- if upsell_items != '' -%}
                  {{ block_style }}
                {%- endif -%}
                {{ block.shopify_attributes }}
              >
                {%- if upsell_items != '' -%}
                  {%- if upsell_slider -%}
                    <div class="upsell__products__slider" data-upsell-slider>
                      {{- upsell_items -}}
                    </div>
                  {%- else -%}
                    {{- upsell_items -}}
                  {%- endif -%}
                {%- endif -%}
              </div>

            {%- when 'complementary-products' -%}
              <div
                class="product__block product__complementary"
                id="Block--{{ block.id }}"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                <complementary-products
                  class="complementary-products"
                  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=10&intent=complementary"
                >
                  {%- if recommendations.performed and recommendations.products_count > 0 -%}
                    {%- assign complementary_products_title = 'general.complementary.products_title' | t -%}

                    {%- if complementary_products_title != blank -%}
                      <p class="complementary-products__title">
                        {{- complementary_products_title -}}
                      </p>
                    {%- endif -%}

                    <div class="complementary-products__slider" data-complementary-slider>
                      {%- for product in recommendations.products -%}
                        <div class="complementary-products__item">
                          {%- liquid
                            assign upsell_unique = block.id | append: '--' | append: forloop.index
                            render 'upsell-product', upsell_product: product, is_complementary: true, unique: upsell_unique, img_sizes: upsells_sizes
                          -%}
                        </div>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </complementary-products>
              </div>

              <script src="{{ 'complementary-products.js' | asset_url }}" defer="defer"></script>

            {%- when 'share-button' -%}
              {%- comment -%} Social Icons {%- endcomment -%}
              <div
                class="product__block"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {%- liquid
                  assign text = block.settings.text

                  if product.url != blank
                    assign link = shop.url | append: product.url
                  else
                    assign link = ''
                  endif

                  render 'share-button', text: text, link: link, animation_anchor: animation_anchor, animation_order: animation_order
                -%}
              </div>

            {%- when 'custom_code' -%}
              <div
                class="product__block"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {{ block.settings.custom_code }}
              </div>

            {%- when 'text' -%}
              {%- assign text_alignment = block.settings.text_alignment -%}
              <div
                class="product__block"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {%- if block.settings.title != blank -%}
                  <div class="product__subheading{% if text_alignment == 'center' %} text-center{% endif %}">
                    {{ block.settings.title }}
                  </div>
                {%- endif -%}
              </div>

            {%- when 'icon' -%}
              {%- liquid
                assign icon_width = block.settings.icon_width
                assign icon_image = block.settings.icon_image
                assign icon_name = block.settings.icon_name
                assign icon_color = block.settings.icon_color
                assign width = block.settings.width
                assign text_size = block.settings.text_size | times: 0.01
                assign text_alignment = block.settings.text_alignment
                assign bg_color = block.settings.bg_color

                if icon_image != blank
                  assign retina_size = icon_width | times: 2
                  assign image_widths = icon_width | append: ', ' | append: retina_size
                  assign sizes = icon_width | append: 'px'
                endif
              -%}

              {%- capture background_style -%}
                --bg: {{ bg_color }};

                {%- if bg_color != 'rgba(0,0,0,0)' and bg_color != '' and bg_color != section.settings.bg_color -%}
                  padding: 5px 10px;
                {%- endif -%}
              {%- endcapture -%}

              {%- capture icon_style -%}
                --icon-size: {{ icon_width }}px;

                {%- if icon_image -%}
                  --aspect-ratio: {{ 1 | divided_by: icon_image.aspect_ratio | times: 100 | round: 1 }}%;
                {%- endif -%}

                {%- if icon_color != '' and icon_color != 'rgba(0,0,0,0)' and icon_image == blank -%}
                  color: {{ icon_color }};
                {%- endif -%}
              {%- endcapture -%}

              {%- capture text_style -%}
                --adjust-body: calc(var(--FONT-ADJUST-BODY) * {{ text_size }});
              {%- endcapture -%}

              <div
                class="product__block{% if width == 'half' %} product__block--half{% endif %}"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                <div
                  class="product__icon__row{% if text_alignment == 'center' %} product__icon__row--center{% endif %}"
                  style="{{ text_style }} {{ background_style }}"
                >
                  {%- unless icon_image == blank and icon_name == 'none' -%}
                    <div class="product__icon icon-stroke" style="{{ icon_style }}">
                      {%- if icon_image != blank -%}
                        <div class="product__icon__holder">
                          {%- render 'image',
                            image: icon_image,
                            width: retina_size,
                            widths: image_widths,
                            sizes: sizes,
                            classes: 'product__icon__img'
                          -%}
                        </div>
                      {%- else -%}
                        {%- render 'icons', icon: icon_name -%}
                      {%- endif -%}
                    </div>
                  {%- endunless -%}

                  {%- if block.settings.icon_text != blank -%}
                    <div class="product__icon__text">{{ block.settings.icon_text }}</div>
                  {%- endif -%}
                </div>
              </div>

            {%- when 'icon_row' -%}
              {%- assign bg_color = block.settings.bg_color -%}
              {%- assign alignment = block.settings.alignment -%}

              {%- capture background_style -%}
                --bg: {{ bg_color }};

                {%- if bg_color != 'rgba(0,0,0,0)' and bg_color != '' and bg_color != section.settings.bg_color -%}
                  padding: var(--grid-gutter);
                {%- endif -%}
              {%- endcapture -%}

              <link
                href="{{ 'section-icons-row.css' | asset_url }}"
                rel="preload"
                as="style"
                onload="this.onload=null;this.rel='stylesheet'"
              >

              <div
                class="product__block text-{{ alignment }}"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                <div class="product__icon__row product__icon__row--multiple" style="{{ background_style }}">
                  {%- render 'icon-row', block_settings: block.settings -%}
                </div>
              </div>

            {% when 'siblings' %}
              {% capture animation_attributes %}
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
              {% endcapture %}

              {% render 'product-siblings',
                product: product,
                block: block,
                animation_attributes: animation_attributes,
                label_text_caps: label_text_caps,
                is_quick_view: is_quick_view
              %}

            {%- when 'inventory_countdown' -%}
              <div
                class="product__block"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                id="Inventory-{{ unique }}"
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {%- render 'inventory-countdown',
                  current_variant: current_variant,
                  max_inventory: block.settings.max_inventory,
                  hide_inventory_count: block.settings.hide_inventory_count
                -%}
              </div>

            {%- when 'popup_text' -%}
              {%- liquid
                assign text = block.settings.text
                assign popup_page = pages[block.settings.popup_page]
                assign popup_content = popup_page.content
              -%}

              <div
                class="product__block product__popup__wrapper"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block_style }}
                {{ block.shopify_attributes }}
              >
                {%- unless text == blank -%}
                  <button
                    type="button"
                    class="product__popup__link label-typography"
                    href="{{ popup_page.url }}"
                    aria-controls="popup-text--{{ block.id }}"
                  >
                    <drawer-toggle></drawer-toggle>
                    <span>{{ text }}</span>
                  </button>

                  {%- capture popup_text -%}
                    {{- popup_text -}}
                    <drawer-element class="product__popup drawer drawer--left cv-h" id="popup-text--{{ block.id }}" aria-hidden="true" role="dialog">
                      <button type="button" class="drawer__close-button" aria-controls="popup-text--{{ block.id }}">
                        <drawer-toggle></drawer-toggle>
                        <span class="visually-hidden">{{ 'general.accessibility.close_drawer' | t }}</span>
                        {%- render 'icon-close' -%}
                      </button>

                      <div class="product__popup__inner" tabindex="0" data-scroll>
                        <div class="product__popup__content rte">
                          {%- if popup_page == blank -%}
                            {{ 'products.product.popup_missing' | t }}
                          {%- elsif popup_content == blank -%}
                            {{ 'products.product.popup_text_missing' | t }}
                          {%- else -%}
                            {{ popup_content }}
                          {%- endif -%}
                        </div>
                      </div>
                    </drawer-element>
                  {%- endcapture -%}
                {%- endunless -%}
              </div>

            {%- when 'line_item_property' -%}
              {%- if block.settings.label != blank -%}
                {%- liquid
                  assign line_item_label = block.settings.label | escape_once
                  assign input_id = 'Form-' | append: section.id | append: '-' | append: block.id

                  assign type = block.settings.type
                  assign field_class = 'product__block__field'
                  case type
                    when 'text'
                      assign field_class = field_class | append: ' product__block__field--text'
                    when 'checkbox'
                      assign field_class = field_class | append: ' product__block__field--checkbox'
                  endcase
                -%}

                <div
                  class="product__block"
                  {% if animations_enabled %}
                    data-aos="hero"
                    data-aos-anchor="{{ animation_anchor }}"
                    data-aos-order="{{ animation_order }}"
                    {%- assign animation_order = animation_order | plus: 1 -%}
                  {% endif %}
                  {{ block_style }}
                  {{ block.shopify_attributes }}
                >
                  <div class="{{ field_class }}">
                    {%- case type -%}
                      {%- when 'text' -%}
                        <label for="{{ input_id }}" class="hidden-label">{{ line_item_label }}</label>

                        {%- if block.settings.allow_long_text -%}
                          <textarea
                            rows="2"
                            name="properties[{{ line_item_label }}]"
                            form="{{ product_form_id }}"
                            id="{{ input_id }}"
                            class="input--full"
                            placeholder="{{ line_item_label }}"
                          ></textarea>
                        {%- else -%}
                          <input
                            type="text"
                            name="properties[{{ line_item_label }}]"
                            form="{{ product_form_id }}"
                            id="{{ input_id }}"
                            class="input--full"
                            placeholder="{{ line_item_label }}"
                            autocorrect="off"
                            autocapitalize="off"
                          >
                        {%- endif -%}

                      {%- when 'checkbox' -%}
                        {%- if block.settings.unchecked_value != blank and block.settings.checked_value != blank -%}
                          <div for="{{ input_id }}" class="checkbox">
                            <input
                              type="hidden"
                              name="properties[{{ line_item_label }}]"
                              form="{{ product_form_id }}"
                              value="{{ block.settings.unchecked_value }}"
                            >

                            <input
                              type="checkbox"
                              name="properties[{{ line_item_label }}]"
                              id="{{ input_id }}"
                              form="{{ product_form_id }}"
                              value="{{- block.settings.checked_value -}}"
                            >

                            <label for="{{ input_id }}">{{ line_item_label }}</label>
                          </div>
                        {%- endif -%}
                    {%- endcase -%}
                  </div>
                </div>
              {%- endif -%}

            {%- when 'divider' -%}
              <div class="product__block" {{ block_style }} {{ block.shopify_attributes }}>
                {%- if block.settings.show_line -%}
                  <hr
                    class="hr--full"
                    {% if animations_enabled %}
                      data-aos="hero"
                      data-aos-anchor="{{ animation_anchor }}"
                      data-aos-order="{{ animation_order }}"
                      {%- assign animation_order = animation_order | plus: 1 -%}
                    {% endif %}
                  >
                {%- endif -%}
              </div>

            {%- when 'feature' -%}{%- liquid
  assign block_id = block.id
  assign prev_index = forloop.index0 | minus: 1
  assign next_index = forloop.index0 | plus: 1
  assign prev_block = section.blocks[prev_index]
  assign next_block = section.blocks[next_index]
  assign bg_color = block.settings.bg_color
  assign text_color = block.settings.text_color
  assign icon_name = block.settings.icon_name
  assign title = block.settings.title
  assign text = block.settings.text
  assign icon_image = block.settings.icon_image
  assign icon_width = block.settings.icon_width

  capture style
    echo '--bg: ' | append: bg_color | append: ';'

    if text_color != '' and text_color != 'rgba(0,0,0,0)'
      echo '--text: ' | append: text_color | append: ';'
      echo '--heading: ' | append: text_color | append: ';'
    endif

    if bg_color != 'rgba(0,0,0,0)' and bg_color != '' and bg_color != section.settings.bg_color
      echo 'padding: ' | append: 'var(--grid-gutter);'
    endif
  endcapture

  capture icon_style
    echo '--icon-size: ' | append: icon_width | append: 'px;'

    if icon_image
      echo 1 | divided_by: icon_image.aspect_ratio | times: 100 | round: 1 | append: '%;' | prepend: '--aspect-ratio: '
    endif

    if text_color != '' and text_color != 'rgba(0,0,0,0)' and icon_image == blank
      echo '--text: ' | append: text_color | append: ';'
    endif
  endcapture
-%}

{%- if forloop.index0 == 0 or prev_block.type != 'feature' -%}
  <div class="product__block product__features"
    {% if animations_enabled %}
      data-aos="hero"
      data-aos-anchor="{{ animation_anchor }}"
      data-aos-order="{{ animation_order }}"
      {%- assign animation_order = animation_order | plus: 1 -%}
    {% endif %}
    data-slider
    {{ block_style }}>
{%- endif -%}

<div class="product__feature"
  data-block-id="{{ block_id }}"
  style="{{ style }}"
  {{ block.shopify_attributes }}>

  <div class="product__feature__content">
    {%- unless icon_image == blank and icon_name == 'none' and title == blank -%}
      <div class="product__feature__icon__container">
        {%- unless icon_image == blank and icon_name == 'none' -%}
          <div class="product__icon icon-stroke" style="{{ icon_style }}">
            {%- if icon_image != blank -%}
              {%- liquid
                assign retina_size = icon_width | times: 2
                assign image_widths = icon_width | append: ', ' | append: retina_size
                assign sizes = icon_width | append: 'px'
              -%}
              <div class="product__icon__holder">
                {%- render 'image',
                  image: icon_image,
                  width: retina_size,
                  sizes: sizes,
                  widths: image_widths,
                  classes: 'product__icon__img' -%}
              </div>
            {%- else -%}
              {%- render 'icons', icon: icon_name -%}
            {%- endif -%}
          </div>
        {%- endunless -%}

        {%- if title != blank -%}
          <div class="product__feature__heading">
            <h5>{{ title }}</h5>
          </div>
        {%- endif -%}
      </div>
    {%- endunless -%}

    {%- if text != blank -%}
      <div class="product__feature__text">
        {{ text }}
      </div>
    {%- endif -%}
  </div>
</div>

{%- if forloop.index == section.blocks.size or next_block.type != 'feature' -%}
  </div>
{%- endif -%}
{%- when 'badges' -%}
              <div
                class="product__block"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {%- if show_badges_over_gallery == false and show_badges -%}
                  {{ block_style }}
                {%- endif -%}
                {{ block.shopify_attributes }}
              >
                {%- if show_badges_over_gallery == false and show_badges -%}
                  <div class="product-badge">
                    {%- if show_custom_badge -%}
                      <div class="product-badge__item product-badge__item--custom">
                        <span>{{ custom_badge_metafield_text }}</span>
                      </div>
                    {%- endif -%}
                    {%- if show_sale_badge -%}
                      <div class="product-badge__item product-badge__item--sale">
                        <span>{{ 'products.product.sale' | t }}</span>
                      </div>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>
            {%- when 'timer' -%}
              {%- liquid
                assign bg_color = block.settings.bg_color
                assign text = block.settings.text
                assign text_align = block.settings.text_align
                assign text_size = block.settings.text_size | times: 0.01
                assign text_color = block.settings.text_color
                assign heading = block.settings.heading
                assign heading_size = block.settings.heading_size | times: 0.01
                assign heading_style = block.settings.heading_style
                assign digits_size = block.settings.digits_size | times: 0.01
                assign digits_size_mobile = digits_size | times: 0.8 | at_least: 0.75
                assign digits_size_unit = digits_size | at_least: 0.8
                assign digits_size_unit_mobile = digits_size_mobile | at_least: 1
              -%}{%- liquid
  assign end_date = block.settings.end_date
  assign end_time = block.settings.end_time
  assign period = block.settings.period
  assign end_message = block.settings.end_message

  assign end_time_hour = end_time | split: ':' | first | times: 1
  assign end_time_minute = end_time | split: ':' | last

  capture expiration_date
    echo end_date
    echo ' '
    case period
      when 'am'
        case end_time_hour
          when 0, 12
            echo '00' | append: ':' | append: end_time_minute
          else
            echo end_time
        endcase

      when 'pm'
        capture hour
          case end_time_hour
            when 0, 12
              echo '12'
            else
              if end_time_hour < 12
                echo end_time_hour | plus: 12
              else
                echo end_time_hour
              endif
          endcase
        endcapture

        echo hour | append: ':' | append: end_time_minute
    endcase
  endcapture
-%}<div
                class="product__block product__block--timer {{ text_align }}"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                id="Block--{{ block.id }}"
                {{ block_style }}
                data-product-timer
                {{ block.shopify_attributes }}
              >
                {%- style -%}
                  #Block--{{ block.id }} { --adjust-heading: calc(var(--FONT-ADJUST-HEADING) * {{ heading_size }}); }
                  #Block--{{ block.id }} { --adjust-body: calc(var(--FONT-ADJUST-BODY) * {{ text_size }}); }
                  #Block--{{ block.id }} .countdown-timer__digit { --adjust-heading: calc(var(--FONT-ADJUST-HEADING) * {{ digits_size_mobile }}); }
                  #Block--{{ block.id }} .countdown-timer__unit { --adjust-unit: calc(var(--FONT-ADJUST-HEADING) * {{ digits_size_unit_mobile }}); }
                  @media screen and (min-width: 768px) {
                    #Block--{{ block.id }} .countdown-timer__digit { --adjust-heading: calc(var(--FONT-ADJUST-HEADING) * {{ digits_size }}); }
                    #Block--{{ block.id }} .countdown-timer__unit { --adjust-unit: calc(var(--FONT-ADJUST-HEADING) * {{ digits_size_unit }}); }
                  }

                  {% if text_color.alpha != 0.0 and text_color != '' %}
                    #Block--{{ block.id }} .countdown-timer { --text: {{ text_color }}; }
                  {% endif %}
                {%- endstyle -%}

                {% render 'countdown-timer',
                  expiration_date: expiration_date,
                  end_message: end_message,
                  leading_zero: true,
                  animation_anchor: animation_anchor,
                  animation_order: animation_order,
                  bg_color: bg_color,
                  bg_opacity: 100,
                  heading: heading,
                  text: text,
                  heading_style: heading_style
                %}
              </div>

            {%- when 'fit-guide' -%}
              {%- liquid
                assign fit_color = block.settings.fit_color
                assign style = ''
                unless fit_color.alpha == 0.0 or fit_color == blank
                  capture style
                    echo '--text:' | append: fit_color
                  endcapture
                endunless
              -%}

              <div
                class="product__block product__guide guide"
                {% if animations_enabled %}
                  data-aos="hero"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-order="{{ animation_order }}"
                  {%- assign animation_order = animation_order | plus: 1 -%}
                {% endif %}
                {{ block.shopify_attributes }}
                {{ block_style }}
              >
                {%- if block.settings.heading != blank -%}
                  <p class="guide__heading strong label-typography">{{ block.settings.heading }}</p>
                {%- endif -%}

                <div class="guide__line" style="{{ style }}">
                  {%- assign selected_segment = block.settings.selected_segment | plus: 0 -%}
                  {%- for idx in (1..5) -%}
                    <span
                      {% if forloop.index == selected_segment %}
                        class="is-active"
                      {% endif %}
                    >
                      {{- forloop.index -}}
                    </span>
                  {%- endfor -%}
                </div>

                {%- if block.settings.left_label != blank
                  or block.settings.middle_label != blank
                  or block.settings.right_label != blank
                -%}
                  <div class="guide__content{% unless block.settings.left_label != blank %} guide__content--skip-left{% endunless %}{% unless block.settings.right_label != blank %} guide__content--skip-right{% endunless %}">
                    {%- if block.settings.left_label != blank -%}
                      <div class="guide__left">{{ block.settings.left_label }}</div>
                    {%- endif -%}

                    {%- if block.settings.middle_label != blank -%}
                      <div class="guide__middle">{{ block.settings.middle_label }}</div>
                    {%- endif -%}

                    {%- if block.settings.right_label != blank -%}
                      <div class="guide__right">{{ block.settings.right_label }}</div>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>
          {%- endcase -%}
        {%- endfor -%}
      </{{ wrapper_tag }}>
    </collapsible-elements>

    {%- if full_width_blocks.size > 0 -%}
      <collapsible-elements class="product__full-width-blocks" data-collapsible-single>
        {%- for block in section.blocks -%}
          {%- unless block.settings.enable_full_width -%}
            {%- continue -%}
          {%- endunless -%}

          {%- liquid
            assign padding_bottom = block.settings.padding_bottom

            if padding_bottom != blank
              capture block_style
                echo 'style="--PBB:' | append: padding_bottom | append: 'px;"'
              endcapture
            endif
          -%}

          {%- if block.type == 'description' and product.description != blank -%}
            <div
              class="product__block product__description rte"
              {% if animations_enabled %}
                data-aos="hero"
                data-aos-anchor="{{ animation_anchor }}"
                data-aos-order="{{ animation_order }}"
                {%- assign animation_order = animation_order | plus: 1 -%}
              {% endif %}
              {{ block_style }}
              {{ block.shopify_attributes }}
            >
              {%- unless product == blank -%}
                {{- product.description -}}
              {%- else -%}
                <p>{{ 'homepage.onboarding.single_product_description' | t }}</p>
              {%- endunless -%}
            </div>
          {%- elsif block.type == 'product_accordion' -%}
            <div
              class="product__block product__accordions"
              id="Block--{{ block.id }}"
              {% if animations_enabled %}
                data-aos="hero"
                data-aos-anchor="{{ animation_anchor }}"
                data-aos-order="{{ animation_order }}"
                {%- assign animation_order = animation_order | plus: 1 -%}
              {% endif %}
              {{ block_style }}
              {{ block.shopify_attributes }}
            >
              {%- render 'product-accordions', product: product, block_settings: block.settings, block_id: block.id -%}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </collapsible-elements>
    {%- endif -%}

    {%- comment -%}Popup text & size chart drawers, leave outsude .form__wrapper otherwise it will break when sticky form is enabled{%- endcomment -%}
    {{- popup_text -}}
    {%- render 'size-chart-drawer', product: product, unique: unique, section_type: section_type -%}

    <script type="application/json" id="ModelJson-{{ unique }}">
      {{ product.media | where: 'media_type', 'model' | json }}
    </script>
  </product-info>
{%- else -%}
  {%- unless multiple_quick_view_items -%}
    <div class="popup-quick-view__inner" data-section-id="{{ unique }}" data-quick-view-inner>
      <product-info
        class="popup-quick-view__item"
        data-section="{{ section_id }}"
        data-section-id="{{ unique }}"
        data-product-handle="{{ product.handle }}"
        data-product-id="{{ product.id }}"
        data-url="{{ product.url }}"
        data-update-url="false"
        {% if product == blank %}
          data-quick-view-onboarding
        {% endif %}
        data-quick-view-item
      >
  {%- endunless -%}

  {%- liquid
    assign gift_card_recipient_feature_active = false

    if settings.show_gift_card_recipient and product.gift_card?
      assign gift_card_recipient_feature_active = true
    endif

    assign title_size = settings.title_size | times: 0.01
    assign title_size_mobile = title_size
    if title_size > 1
      assign title_size_mobile = title_size | times: 0.8 | at_least: 1.05
    endif
    assign price_size = settings.price_size | times: 0.01
    assign price_size_mobile = price_size
    if price_size > 1
      assign price_size_mobile = price_size | times: 0.8 | at_least: 1.05
    endif
    assign bold_price = settings.product_bold_price

    if title_size != 1
      capture title_style
        echo ' style="'
        echo '--adjust-heading-desktop: calc(var(--FONT-ADJUST-HEADING) * ' | append: title_size | append: '); '
        echo '--adjust-heading-mobile: calc(var(--FONT-ADJUST-HEADING) * ' | append: title_size_mobile | append: ');'
        echo '"'
      endcapture
    endif
  -%}

  {%- if product != blank -%}
    <product-form
      class="product__form popup-quick-view__form popup-quick-view__form--{{ settings.quick_buy_image_layout }}"
      data-form-wrapper
      data-quick-view-focus
      data-scroll-lock-scrollable
    >
      <div class="popup-quick-view__wrapper product__form__wrapper{{ hide_labels_class }}{% if sold_out %} variant--soldout{% endif %}">
        <div class="popup-quick-view__body" data-scroll-lock-scrollable data-quick-view-body>
          {%- if quick_view_nav != '' -%}
            {{- quick_view_nav -}}
          {%- endif -%}

          <div class="popup-quick-view__body__inner" data-quick-view-body-inner>
            <div class="popup-quick-view__content">
              <a
                href="#"
                title="{{ 'general.accessibility.close' | t }} (Esc)"
                class="popup-quick-view__close"
                data-popup-close
              >
                {%- render 'icon-close' -%}
              </a>

              <h1
                class="popup-quick-view__title"
                {% if title_style != blank %}
                  {{- title_style -}}
                {% endif %}
              >
                <a href="{{ product_url }}" title="{{ product_title }}">{{ product_title }}</a>
              </h1>{%- liquid
  assign currency_code_enable = settings.currency_code_enable

  if price_size != 1
    capture price_style
      echo ' style="'
      echo '--adjust-body-desktop: calc(var(--FONT-ADJUST-BODY) * ' | append: price_size | append: ');'
      if price_size_mobile != blank
        echo ' --adjust-body-mobile: calc(var(--FONT-ADJUST-BODY) * ' | append: price_size_mobile | append: ');'
      endif
      echo '"'
    endcapture
  endif

  assign show_saving_badge = settings.show_saving_badge
  assign saving_badge_type = settings.saving_badge_type
  assign global_final_sale_enabled = settings.final_sale

  # Check final sale status - global setting acts as master switch
  assign is_final_sale = false
  if global_final_sale_enabled
    # Only check metafields if global setting is enabled

    # First check variant-level metafield (highest priority)
    assign variant_sale_product = current_variant.metafields.theme.final_sale.value
    if variant_sale_product != null
      # Variant metafield exists - use its value (true or false)
      assign is_final_sale = variant_sale_product
    else
      # No variant metafield - check product-level metafield
      assign final_sale_product = product.metafields.theme.final_sale.value
      unless final_sale_product == null
        assign is_final_sale = final_sale_product
      endunless
    endif
  endif

  assign color_body_text = settings.color_body_text
  assign final_sale_color = settings.final_sale_color

  if final_sale_color.alpha == 0.0 or final_sale_color == ''
    assign final_sale_color = color_body_text
  endif

  capture sale_style
    echo '--final-sale-color: ' | append: final_sale_color | append: ';'
  endcapture
  assign discount_amount = ''
  assign compare_price = current_variant.compare_at_price | times: 1.0
  assign sale_price = current_variant.price | times: 1.0

  if compare_price and sale_price
    if compare_price > sale_price
      if saving_badge_type == 'percentage'
        assign discount_difference = compare_price | minus: sale_price
        assign discount_percentage = discount_difference | divided_by: compare_price | times: 100
        assign discount_int = discount_percentage | round
        if discount_int > 0
          assign discount_amount = discount_int | append: '%'
        endif
      else
        assign discount = compare_price | minus: sale_price
        if discount > 0
          if settings.currency_code_enable
            assign discount_amount = discount | money_with_currency
          else
            assign discount_amount = discount | money
          endif
        endif
      endif
    endif
  endif
-%}

{% capture saving_final_sale_markup %}
  {% if show_saving_badge or is_final_sale %}
    <span class="product__price--off"
      {% if is_final_sale %} data-final-sale{% endif %}
      style="{{ sale_style }}"
    >
      {% if show_saving_badge and discount_amount != '' %}
        <span class="product__price-badge">
          {{ 'products.product.save' | t }}
          <span>{{ discount_amount }}</span>
        </span>
      {% endif %}

      {%- if is_final_sale -%}
        <span class="product__final-sale-wrap">
          <span class="product__final-sale">{{ 'products.product.final_sale' | t }}</span>
          <tooltip-component class="product__final-sale-question" data-tooltip="{{ settings.final_sale_tooltip | replace: '"', "'" }}">{%- render 'icon-question' -%}</tooltip-component>
        </span>
      {%- endif -%}
    </span>
  {% endif %}
{% endcapture %}

<div
  class="product__block product__price-and-badge"
  {% if animations_enabled %}
    data-aos="hero"
    data-aos-anchor="{{ animation_anchor }}"
    data-aos-order="{{ animation_order }}"
    {%- assign animation_order = animation_order | plus: 1 -%}
  {% endif %}
  {{ block_style }}
>
  <div class="product__price-wrapper" id="Price-{{ unique }}">
    <div
      class="product__price"
      data-price-wrapper
      {% if price_style != blank %}
        {{- price_style -}}
      {% endif %}
    >
      {%- unless product == blank -%}
        <span
          data-product-price
          class="product__price--regular{% if current_variant.compare_at_price > current_variant.price %} product__price--sale{% endif %}{% if bold_price %} product__price--bold{% endif %}"
        >
          {%- liquid
            if current_variant.price == 0
              echo 'products.product.free' | t
            elsif currency_code_enable
              echo current_variant.price | money_with_currency
            else
              echo current_variant.price | money
            endif
          -%}
        </span>
      {%- else -%}
        <span id="ProductPrice" class="product__price--regular{% if bold_price %} product__price--bold{% endif %}">
          {%- liquid
            if currency_code_enable
              echo 1999 | money_with_currency
            else
              echo 1999 | money
            endif
          -%}
        </span>
      {%- endunless -%}

      {% comment %}Only show compare price if it's greater than the selling price{% endcomment %}
      {% if current_variant.compare_at_price > current_variant.price %}
        <s data-compare-price class="product__price--compare{% if bold_price %} product__price--bold{% endif %}">
          {%- liquid
            if currency_code_enable
              echo current_variant.compare_at_price | money_with_currency
            else
              echo current_variant.compare_at_price | money
            endif
          -%}
        </s>
      {% endif %}

      {%- liquid
        assign units = product.variants | map: 'unit_price' | compact
        if units[0]
          assign has_units = true
        else
          assign has_units = false
        endif
      -%}

      {%- if has_units -%}
        {%- assign current_variant_unit_price = current_variant.unit_price -%}

        {%- capture unit_price_separator -%}
          <span aria-hidden="true">/</span><span class="visually-hidden">{{ 'general.accessibility.unit_price_separator' | t }}&nbsp;</span>
        {%- endcapture -%}

        {%- capture unit_price_base_unit -%}
          <span>
            {%- if current_variant.unit_price_measurement -%}
              {% if current_variant.unit_price_measurement.reference_value != 1 %}
                {{ current_variant.unit_price_measurement.reference_value }}
              {% endif %}
              {{ current_variant.unit_price_measurement.reference_unit }}
            {%- endif -%}
          </span>
        {%- endcapture -%}

        <span class="product__unit-price">
          <span
            data-product-unit
            class="product__price--unit{% unless current_variant_unit_price %} hidden{% endunless %}"
          >
            <span class="visually-hidden">{{ 'products.product.unit_price_label' | t }}</span>
            <span data-product-unit-price id="unit-price-{{ section.id }}">
              {{- current_variant_unit_price | money -}}
            </span>
            {{ unit_price_separator }}
            <span data-product-base id="unit-price-base-{{ section.id }}">{{ unit_price_base_unit }}</span>
          </span>
        </span>
      {%- endif -%}

      {{ saving_final_sale_markup }}
    </div>
  </div>
</div>
</div>

            <div class="popup-quick-view__gallery">
              {{- product_gallery -}}
            </div>
          </div>

          <div class="popup-quick-view__form-inner">
            {%- comment -%} Product Form Variants {%- endcomment -%}
            {%- render 'product-form',
              product: product,
              section: section,
              section_id: section_id,
              product_form_id: product_form_id,
              current_variant: current_variant,
              cart_qty: cart_qty,
              unique: unique,
              animations_enabled: animations_enabled,
              animation_anchor: animation_anchor,
              animation_order: animation_order,
              show_quantity: show_quantity,
              show_remaining: show_remaining,
              show_labels: show_labels,
              label_text_caps: label_text_caps,
              is_quick_view: is_quick_view
            -%}
          </div>

          {%- if settings.quick_buy_text == 'cutline' -%}{%- if product.metafields.theme.cutline != blank and product.metafields.theme.cutline.type == 'single_line_text_field' -%}

{%- liquid
  capture style
    case cutline_color
      when 'body'
        echo 'color: var(--text);'
      when 'accent'
        echo 'color: var(--accent);'
    endcase
  endcapture
-%}

  <p class="product-cutline" style="{{ style }}">{{ product.metafields.theme.cutline.value }}</p>
{%- endif -%}
{%- elsif settings.quick_buy_text == 'description' -%}
            <p>{{ product.description | strip_html | truncatewords: settings.quick_buy_text_length }}</p>
          {% endif %}
        </div>

        <div class="popup-quick-view__foot" data-quick-view-foot>
          {%- comment -%} We need the "foot__inner" container to avoid the vertical scroll that appears when animating the foot element {%- endcomment -%}
          <div class="popup-quick-view__foot__inner" data-quick-view-foot-inner>
            {%- comment -%} Product Form Buttons {%- endcomment -%}
            {%- render 'buy-buttons',
              product: product,
              product_form_id: product_form_id,
              unique: unique,
              is_quick_view: is_quick_view,
              show_quantity: show_quantity,
              show_payment_button: show_payment_button,
              animations_enabled: animations_enabled,
              sold_out: sold_out
            -%}

            <a class="popup-quick-view__view-button popup-quick-view__view-button--desktop" href="{{ product_url }}">
              {{- 'products.general.view_all_details' | t -}}
            </a>
          </div>

          {%- if show_free_shipping_message -%}
            {%- render 'cart-empty-message' -%}
          {%- endif -%}
        </div>
      </div>

      <script type="application/json" id="ModelJson-{{ unique }}">
        {{ product.media | where: 'media_type', 'model' | json }}
      </script>
    </product-form>
  {%- else -%}
    {%- render 'product-quick-view-form-onboarding',
      unique: unique,
      product_url: product_url,
      product_title: product_title,
      product_gallery: product_gallery,
      quick_view_nav: quick_view_nav,
      hide_labels_class: hide_labels_class,
      animation_anchor: animation_anchor,
      animation_order: animation_order,
      title_style: title_style,
      price_size: price_size,
      price_size_mobile: price_size_mobile,
      bold_price: bold_price,
      show_free_shipping_message: show_free_shipping_message,
      label_text_caps: label_text_caps
    -%}
  {%- endif -%}

  {%- render 'size-chart-drawer', product: product, unique: unique, section_type: section_type -%}

  {%- unless multiple_quick_view_items -%}
    </product-info>
    </div>
  {%- endunless -%}
{%- endunless -%}
